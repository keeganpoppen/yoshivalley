<html>
    <head>
        <title>Object Sync Demo</title>
        <script src="/yepnope.1.0.1-min.js"></script>
        <!--
		<script src="/jquery-1.5.1.min.js"></script>
		<script src="/socket.io.js"></script>
        <script src="/underscore-min.js"></script>
        <script src="/microevent.js"></script>
        -->
        <script src="/load.js"></script>
        <script>
            //copied!
            var NAMESPACE_SEPARATOR = '.'

            function getUTCMillis(){
                var d  = new Date()
                return d.getTime() + (d.getTimezoneOffset() + 60 * 1000)
            }
            
        </script>
        <script>
            var AutoSync = (function(){
                var autosync = function(){ return null }

                //load all them hot, hot dependencies
                Load(['/event_router.js', '/microevent.js'], function(){
                    var autosync_map = {}

                    var autosync_router = new EventRouter(SocketRouter, 'autosync', function(route_arr, message){
                        if(route_arr.length < 2) return
                        if(route_arr[0] == 'create' && route_arr[1] in autosync_map) return

                        var autosync_obj = autosync_map[route_arr[1]] || new autosync(route_arr[1],{})

                        //to avoid an 'update' endless loop
                        autosync_obj.chatty = false

                        //getters and setters should take care of the rest
                        $.extend(true, autosync_obj, message.data)

                        console.log('object now updated to: ', autosync_obj)

                        //otherwise updating is good
                        autosync_obj.chatty = true

                        autosync_map[route_arr[1]] = autosync_obj
                    })

                    SocketRouter.addRouter('autosync', autosync_router)

                    MicroEvent.mixin(AutoSync)

                    autosync = function(name, obj) {
                        console.log('creating new autosync obj with name: ' + name)
                        
                        if(name in autosync_map) throw "oops";
                        autosync_map[name] = this

                        var _syncName = name
                        var history = {}
                        this.getHistory = function(){ return history; }
                        this.chatty = true

                        var data = {}
                        var that = this

                        function archiveValue(key){
                            if(_.isEmpty(history[key])) history[key] = []

                            history[key].push({
                                time: getUTCMillis(),
                                value: data[key]
                            })
                        }

                        _.each(obj, function(value, key) {
                            that.__defineGetter__(key, function(){
                                //console.log('get')
                                return data[key]
                            })
                            that.__defineSetter__(key, function(newval){
                                //console.log('set')
                                archiveValue(key)
                                data[key] = newval

                                var update_packet = {}
                                update_packet[key] = newval

                                if(that.chatty) {
                                    autosync_router.send({
                                        type: ['update',name].join('.'),
                                        data: update_packet
                                    })
                                }
                                return newval
                            })

                            data[key] = value
                        })

                        console.log(data)

                        autosync_router.send({
                            type: ['create',name].join('.'),
                            data: data
                        })
                    }

                    window.awesometest = new autosync('test', {
                        key1: 1,
                        key2: 2
                    })

                })

                return autosync
            })();
        </script>
    </head>
    <body>
        <div style="width:800px;margin:auto;background-color:#1aff00;padding:30px 40px;">
            <div style="width:400px;margin:auto;font-family:'Futura';font-size:48px;">
                <marquee>WELCOME TO OBJECT SYNC, BRAH!</marquee>
            </div>
        </div>
    </body>
</html>
